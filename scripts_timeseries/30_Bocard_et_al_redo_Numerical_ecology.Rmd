---
title: "Bocard et al redo"
author: "Julia Gustavsen"
date: "03/04/2015"
output: html_document
---

I am working through Bocard et al 2011 as a way to learn more about my ecological analyses and perhaps as a way to update the analyses in the book. I will think about ways to update this without copyright infringement later. Right now this is for my benefit. 

## Chapter 2 Reading and playing with the data (Chapter 2 Exploratory Data Analysis)

They call Exploratory data analysis-EDA. I don't like this. But I am very interested in transforming my data. I can do the examples with their data and then repeat with my data. 



```{r}
library (ade4)
data (doubs)
spe <- doubs$fish
env <- doubs$env
spa <- doubs$xy
str(spe)
str(env)
str(spa)
```


They do some very elementary viewing of the data set. I will pass for now. 


```{r}
summary(spe) ## Descriptive statistics for columns
## could use dplyr here?
range(spe) ## gives min, max for abundance values of data set
ab <- table(unlist(spe)) #Count cases for each abundance class
ab
## barplot of the distribution. all species confounded
barplot(ab, las=1, xlab="Abundance class", ylab="Frequency", col=grey(5:0/5))
sum(spe == 0) #Number of absences
# Proportion of zeros in the community data set
nrow(spe)
ncol(spe)
nrow(spe)*ncol(spe) # so how 
sum(spe == 0)/(nrow(spe)*ncol(spe))

```
what is nrow and ncol?
from help"nrow and ncol return the number of rows or columns present in x."

(add in ggplot and dplyr of these things)


```{r}
## Map of the sites
plot(spa, asp=1, type="n", main="Site Locations", xlab="x coordinate (km)", ylab="y coordinate (km)")
## this creates an empty frame for the data

# Add line connect the site (Doub river)
lines(spa, col="light blue")
## add site labels
text(spa, row.names(spa), cex=0.8, col="red")
## Add text blocks
text(50,10, "Upsteam", cex=1.2, col="red")
text(30,120, "Downstream", cex=1.2, col="red")
```

ggplot this?

```{r}


library(ggplot2)
ggplot(spa, aes(x=x, y=y))+
  labs(y="y coordinate (km)",
       x="x coordinate (km)",
       title="Site Locations")+
 geom_path(colour="light blue")+
 geom_text(label=row.names(spa), 
           colour="red",
           size=5)+
 annotate("text", 
          x = 50,
          y = 10,
          label = "Upstream",
          colour="red",
          size = 6)+
 annotate("text",
          x = 30,
          y = 120,
          label = "Downstream",
          colour="red", 
          size = 6)+
 theme_bw()+
 theme(panel.grid.major =  element_blank())
 
```

Nice! Happy with my new graph. Learned things about ggplot too!


```{r}
## Map of the fish species
plot(spa, asp=1, col="brown", cex=spe$Satr, main="Brown trout", xlab="x coordinate (km)", ylab="y coordinate (km)")
lines(spa, col="light blue")

plot(spa, asp=1, col="brown", cex=spe$Thth, main="Grayling", xlab="x coordinate (km)", ylab="y coordinate (km)")
lines(spa, col="light blue")


plot(spa, asp=1, col="brown", cex=spe$Abbr, main="Freshwater bream", xlab="x coordinate (km)", ylab="y coordinate (km)")
lines(spa, col="light blue")

plot(spa, asp=1, col="brown", cex=spe$Baba, main="Barbel", xlab="x coordinate (km)", ylab="y coordinate (km)")
lines(spa, col="light blue")

```



```{r}
ggplot(spa, aes(x=x,y=y))+geom_path()+geom_point(size=spe$Baba*2, shape=1)
```


Look at the relative frequencies of each species

```{r}
## second column in apply is to do the summing by column
spe.pres <- apply(spe > 0, 2, sum)
sort(spe.pres) #sort by increasing order
## percentage frequencies
spe.relf <- 100 *spe.pres/nrow(spe) # relative frequencies
round(sort(spe.relf), 1) # round to 1 digit
round(spe.relf,1)
hist(spe.pres, main="Species Occurences", right=FALSE, las=1, xlab="Number of occurences", ylab="Number of species", breaks=seq(0,30, by=5), col="bisque")
hist(spe.relf, main="Species, Relative Frequencies", right=FALSE, las=1, xlab="Frequency of occurrences (%)", ylab="Number of species", breaks=seq(0,100, by=10), col="bisque")
```

Now looking at species richness

```{r}
## number of species at each site
## sum by rows then second argument of apply is set to 1
sit.pres <- apply(spe > 0, 1, sum)
sort(sit.pres) # sort by number of species

## plot species richness vs . position of the sites along the river
plot(sit.pres, type="s", las=1, col="gray", main="Species Richness vs. \n Upstream-Downstrea Gradient", xlab="Positions of sites along the river", ylab="Species richness")
text(sit.pres, row.names(spe), cex=.8, col="red")

## Use geographic coordinates to plot a bubble map
plot(spa, asp=1, main="Map of Species Richness", pch=21, col="white", bg="brown", cex=5*sit.pres/max(sit.pres), xlab="x coordinate (km)", ylab="y coordinate (km)")
lines(spa, col="light blue")
```


Try with ggplot and dplyr
```{r}
library(plyr)
library(dplyr)
sit.pres <- apply(spe > 0, 1, sum)
sit.pres.df <- as.data.frame(sit.pres)
ggplot(sit.pres.df, aes(x=as.numeric(as.character(row.names(sit.pres.df))),
                        y=sit.pres))+
 labs(y="Species richness",
      x="Positions of sites along the river",
      title="Species Richness vs. \n Upstream-Downstrea Gradient")+
 geom_step()+
 geom_text(label=row.names(spa), 
           colour="red",
           size=5)


ggplot(spa, aes(x=x,y=y))+
  labs(y="y coordinate (km)",
      x="x coordinate (km)",
      title="Map Species Richness")+
 geom_path(colour="light blue")+
 geom_point(size=10*sit.pres/max(sit.pres), colour="brown")



```


Want to look at the classical diversity using vegan

```{r}
library(vegan)
N0 <- rowSums(spe >0) # Species richness
H <- diversity(spe) # Shannon entropy
N1 <- exp(H) #Shannon diveristy number
## what is the difference between Shannon entropy and Shannon diversity?
##exp() computes the exponential function
N2 <- diversity(spe,"inv") # Simpson diversity number
J <- H/log(N0) #Pielou evennes
E1 <- N1/N0  # Shannon evenness (Hill's ration)
E2 <- N2/N0  #Simpson evennes (Hill's ration)
div <- data.frame(N0,H, N1,N2,E1,E2, J)
div
```

## 2.2.4 Species Data Transformation

There are "instances" where you need to transform the data
* need to make data in different units comparable
* need to make the variables normal

For species abundances you can use fairly simple transformations to reduce the "importance" of very high values. Can use `sqrt()`, `sqrt(sqrt())` (fourth root), or `log1p()` (natural log of abundance+1 to keep absence as zero)

* can use `decostand()` in vegan for standardizing data

```{r}
help(decostand) ## so see that you can do the hellinger transformation here. 

## to transform to presence-absence
spe.pa <- decostand(spe,method="pa")
spe.pa

spe.scal <- decostand(spe, "max") ##scale by dividing by max value for each species
apply(spe.scal,2,max) ## displays the max by column

spe.relsp <- decostand(spe, "total", MARGIN=2) ## this gives relative abundance per species -scales abundances by dividing them by speices totals
spe.relsp
apply(spe.relsp,2,sum)

## scale now by dividing by site totals
spe.rel <- decostand(spe, "total")
apply(spe.rel,1,sum)

## Give a length of 1 to each row vector (Euclidean norm)
## don't really understand Euclidean norm...
## this is a chord transformation
spe.norm <- decostand(spe, "normalize")
spe.norm
## Verify that norm (??) of row vectors
norm <- function(x) sqrt(x%*%x)
apply(spe.norm,1,norm)

## This one, the Hellinger, computes relative frequenceies by rows and then takes the square root. 
spe.hel <- decostand(spe, "hellinger")
spe.hel
## check the norm of the row vectors
apply(spe.hel,1,norm)

## Standardizing both speices and sites (double profiles)
spe.chi <- decostand(spe, "chi.square")
spe.chi

## Can also do with Wisconsin standardization-abundances first ranged by largest number of species and then by site totals
spe.wis <- wisconsin(spe)
spe.wis
```

Have a look at these to see what is going on

```{r}
boxplot(spe$Neba, sqrt(spe$Neba), log1p(spe$Neba),las=1, main="Simple transformation", names=c("raw data", "sqrt", "log"), col="bisque")

boxplot(spe.scal$Neba, spe.relsp$Neba, las=1, names=c("max", "total"), col="lightgreen")

boxplot(spe.hel$Neba, spe.rel$Neba, spe.norm$Neba, las=1, main="Standardization by sites", names=c("Hellinger", "total", "norm"), col="lightblue")

boxplot(spe.chi$Neba, spe.wis$Neba, las=1, main="Double standardization", names=c("Chi-square", "Wisconsin"), col="orange")

```

What about comparing these transformations along the river gradient?

```{r}
## not sure that this is the right variable
plot(env$dfs, spe$Satr, type="l", col=4, main="Raw data", xlab="Distance form the source (km)", ylab="Raw abundance code")
lines (env$dfs, spe$Neba, col=3)
lines(env$dfs, spe$Thth, col="orange")
lines(env$dfs, spe$Teso, col=2)
lines(env$dfs, spe$Pefl, col=1, lty="dotted")

## look at standardized abundance

plot(env$dfs, spe.scal$Satr, type="l", col=4, main="Standardized abundance", xlab="Distance form the source (km)", ylab=" abundance code")
lines (env$dfs, spe.scal$Neba, col=3)
lines(env$dfs, spe.scal$Thth, col="orange")
lines(env$dfs, spe.scal$Teso, col=2)
lines(env$dfs, spe.scal$Pefl, col=1, lty="dotted")


plot(env$dfs, spe.hel$Satr, type="l", col=4, main="Site profiles (hellinger)", xlab="Distance form the source (km)", ylab=" abundance code")
lines (env$dfs, spe.hel$Neba, col=3)
lines(env$dfs, spe.hel$Thth, col="orange")
lines(env$dfs, spe.hel$Teso, col=2)
lines(env$dfs, spe.hel$Pefl, col=1, lty="dotted")

plot(env$dfs, spe.chi$Satr, type="l", col=4, main="Double profiles (Chi-square)", xlab="Distance form the source (km)", ylab=" abundance code")
lines (env$dfs, spe.chi$Neba, col=3)
lines(env$dfs, spe.chi$Thth, col="orange")
lines(env$dfs, spe.chi$Teso, col=2)
lines(env$dfs, spe.chi$Pefl, col=1, lty="dotted")


```

Environmental data
Look at some of it in context

```{r}

plot(spa, asp=1, main="Altitude", pch=21, col="white", bg="red", cex=5*env$alt/max(env$alt), xlab="x", ylab="y")
lines(spa, col="light blue")
plot(spa, asp=1, main="Discharge", pch=21, col="white", bg="blue", cex=5*env$flo/max(env$flo), xlab="x", ylab="y")
lines(spa, col="light blue")
plot(spa, asp=1, main="Oxygen", pch=21, col="white", bg="green3", cex=5*env$oxy/max(env$oxy), xlab="x", ylab="y")
lines(spa, col="light blue")

plot(spa, asp=1, main="Nitrate", pch=21, col="white", bg="brown", cex=5*env$nit/max(env$nit), xlab="x", ylab="y")
lines(spa, col="light blue")


```

Skipping the section on descriptors along the stream...

```{r, echo=FALSE}
## add in the functions for the pairs 

panel.cor <- function(x, y, method="pearson", digits=3, cex.cor=1.2, no.col=FALSE)
{
 usr <- par("usr"); on.exit(par(usr))
	par(usr = c(0, 1, 0, 1))
	r <- cor(x, y, method=method)
	ra <- cor.test(x, y, method=method)$p.value
	txt <- round(r, digits)
	prefix <- ""
	if(ra <= 0.1) prefix <- "."
	if(ra <= 0.05) prefix <- "*"
	if(ra <= 0.01) prefix <- "**"
	if(ra <= 0.001) prefix <- "***"
	if(no.col)
	{
		color <- 1
		if(r < 0) { if(ra <= 0.001) sig <- 4 else sig <- 3 }
		else { if(ra <= 0.001) sig <- 2 else sig <- 1 }
	}
	else
	{
		sig <- 1
		if(ra <= 0.001) sig <- 2
		color <- 2
		if(r < 0) color <- 4
	}
	txt <- paste(txt, prefix, sep="\n")
	text(0.5, 0.5, txt, cex = cex.cor, font=sig, col=color)
}


## Put histograms on the diagonal
panel.hist <- function(x, no.col=FALSE, ...)
{
	usr <- par("usr"); on.exit(par(usr))
	par(usr = c(usr[1:2], 0, 1.5) )
	his <- hist(x, plot=FALSE)
	breaks <- his$breaks; nB <- length(breaks)
	y <- his$counts
	y <- y/max(y)
	if(no.col) rect(breaks[-nB], 0, breaks[-1], y, col="gray", ...)
	else rect(breaks[-nB], 0, breaks[-1], y, col="cyan", ...)
}


## Add black lowess curves to scatter plots
panel.smoothb <- function (x, y, col=par("col"), bg=NA, pch=par("pch"), 
	cex=1, col.smooth="black", span=2/3, iter=3, ...) 
{
	points(x, y, pch=pch, col=col, bg=bg, cex=cex)
	ok <- is.finite(x) & is.finite(y)
	if (any(ok)) 
	lines(stats::lowess(x[ok], y[ok], f=span, iter=iter), col=col.smooth, ...)
}
```

```{r}
pairs(env, panel=panel.smooth, diag.panel=panel.hist, main="Bivariate plots with histogram and Smooth curves")
```


## Now test out transformation of the data

```{r}

#range(env$pen) 'pente' is slope
range(env$slo)
hist(env$slo, col="bisque", right=F)
hist(log(env$slo), col="light green", right=FALSE, main="histogram of log(env$slo)")

boxplot(env$slo, col="bisque", main="Boxplot of env$slo", ylab="env$pen")

boxplot(log(env$slo), col="bisque", main="Boxplot of log(env$slo)", ylab="env$pen")

## so now it looks good!
```

Test out the normality using Shapiro-Wilk test

shapiro.test()

```{r}
shapiro.test(env$slo)
shapiro.test(log(env$slo))
## trying to learn to interpret these tests. Seems like it is a process. 
qqnorm(env$slo)
qqnorm(log(env$slo))
```

Standarization of all environmental variables
(and I think this is where ggplot will come in more handy)

```{r}
#Center and scale=standardize variables (z-scores)
env.z <- decostand(env, "standardize")
apply(env.z, 2, mean) # book says means should be 0 here, but that is not what I get. 
apply(env.z, 1, mean) 
apply(env.z, 2, sd)


```

Use ggplot to have a look at all of them 

```{r}
library(reshape2)
melted_env <- melt(env)
ggplot(melted_env, aes(x=value))+
        geom_histogram()+
        facet_wrap(~variable,scales = "free")

ggplot(melted_env, aes(x=variable, y=value))+
        geom_boxplot()+
 facet_wrap(~variable,scales = "free")

ggplot(melted_env, aes(x=variable, y=log(value)))+
        geom_boxplot()+
 facet_wrap(~variable,scales = "free")

melted_env.z <- melt(env.z)
ggplot(melted_env.z, aes(x=value))+
        geom_histogram(binwidth = 1)+
        facet_wrap(~variable)

ggplot(melted_env.z, aes(x=variable, y=value))+
        geom_boxplot()+
 facet_wrap(~variable,scales = "free")

```


